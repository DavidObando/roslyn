<!-- Copyright (c)  Microsoft.  All Rights Reserved.  Licensed under the Apache License, Version 2.0.  See License.txt in the project root for license information. -->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net472</TargetFramework>
    <RoslynProjectType>Custom</RoslynProjectType>

    <!-- VS Insertion -->
    <TargetVsixContainerName>Roslyn.VisualStudio.Setup.ServiceHub.vsix</TargetVsixContainerName>
    <VisualStudioInsertionComponent>Microsoft.CodeAnalysis.LanguageServices</VisualStudioInsertionComponent>
  </PropertyGroup>

  <Target Name="_SetSwrFilePath">
    <PropertyGroup>
      <_SwrFilePath>$(IntermediateOutputPath)Roslyn.VisualStudio.Setup.ServiceHub.swr</_SwrFilePath>
    </PropertyGroup>
  </Target>
  
  <Target Name="_GenerateSwrFile" 
          AfterTargets="Build"
          BeforeTargets="SwixBuild"
          DependsOnTargets="_SetSwrFilePath;GenerateServiceHubConfigurationFiles"
          Outputs="$(_SwrFilePath)">

    <ItemGroup>
      <_ServiceHubConfigFiles Include="$(IntermediateOutputPath)*.servicehub.service.json" />
      <_FileEntries Include='file source="%(_ServiceHubConfigFiles.Identity)"'/>
    </ItemGroup>

    <PropertyGroup>
      <_Lines>
        <![CDATA[use vs

package name=$(VisualStudioInsertionComponent)
        version=$(VsixVersion)

folder InstallDir:\Common7\ServiceHub\Services\RoslynCodeAnalysisService
  @(_FileEntries, '%0d%0a  ')
]]>
      </_Lines>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(_SwrFilePath)" Lines="$(_Lines)" Overwrite="true"/>

    <ItemGroup>
      <FileWrites Include="$(_SwrFilePath)"/>
      <SwrFile Include="$(_SwrFilePath)"/>
    </ItemGroup>
  </Target>
  
  <ItemGroup>
    <ServiceHubService Include="roslynCodeAnalysis" ClassName="Microsoft.CodeAnalysis.Remote.CodeAnalysisService" />
    <ServiceHubService Include="roslynRemoteHost" ClassName="Microsoft.CodeAnalysis.Remote.RemoteHostService" />
    <ServiceHubService Include="roslynSnapshot" ClassName="Microsoft.CodeAnalysis.Remote.SnapshotService" />
    <ServiceHubService Include="roslynRemoteSymbolSearchUpdateEngine" ClassName="Microsoft.CodeAnalysis.Remote.RemoteSymbolSearchUpdateEngine" />
  </ItemGroup>
  <Import Project="$(RepositoryEngineeringDir)targets\GenerateServiceHubConfigurationFiles.targets" />
</Project>
